{% extends 'base.html' %}
{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h1 class="h4 fw-bold mb-0 d-flex align-items-center gap-2">
        <span class="material-icons" style="color:#1a1a1a">event_available</span> Attendance Records
    </h1>
    {% if role in ('Admin','HR Staff') %}
    <a href="{{ url_for('attendance.create_attendance') }}" class="btn btn-sm" style="background:#1a1a1a;color:#fff">
        <span class="material-icons" style="font-size:16px;vertical-align:-3px">add</span> Add Record
    </a>
    {% endif %}
</div>
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white border-bottom fw-semibold">Attendance Records</div>
    <div class="table-responsive">
        <table class="table table-hover mb-0" id="att-table">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Status</th>
                    {% if role in ('Admin','HR Staff') %}<th>Employee</th>
                    <th>Actions</th>{% endif %}
                </tr>
            </thead>
            <tbody>
                <!-- Populated by DataTables AJAX -->
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const role = '{{ role }}';

        // Columns configuration based on role
        const columns = [
            { data: 'attendance_id' },
            { data: 'date_col' },
            {
                data: 'status',
                render: function (data, type, row) {
                    let badgeClass = 'bg-primary';
                    if (data === 'Present') badgeClass = 'bg-success';
                    else if (data === 'Absent') badgeClass = 'bg-danger';
                    return `<span class="badge ${badgeClass}">${data}</span>`;
                }
            }
        ];

        if (role === 'Admin' || role === 'HR Staff') {
            columns.push({ data: 'emp_name' });
            columns.push({
                data: null,
                orderable: false,
                searchable: false,
                render: function (data, type, row) {
                    const editUrl = `{{ url_for('attendance.list_attendance') }}${row.attendance_id}/edit`;
                    const deleteUrl = `{{ url_for('attendance.list_attendance') }}${row.attendance_id}/delete`;

                    return `
                    <a href="${editUrl}" class="btn btn-sm btn-outline-primary py-0 px-2">
                        <span class="material-icons" style="font-size:15px;vertical-align:-3px">edit</span>
                    </a>
                    <form method="POST" action="${deleteUrl}" class="delete-form d-inline">
                        <button type="submit" class="btn btn-sm btn-outline-danger py-0 px-2">
                            <span class="material-icons" style="font-size:15px;vertical-align:-3px">delete</span>
                        </button>
                    </form>
                `;
                }
            });
        }

        // Initialize Server-Side DataTables
        $('#att-table').DataTable({
            serverSide: true,
            processing: true,
            ajax: {
                url: '{{ url_for("attendance.list_attendance_api") }}',
                type: 'GET'
            },
            columns: columns,
            order: [[1, 'desc']], // Default order by date descending
            language: {
                search: '',
                searchPlaceholder: 'Search...',
                lengthMenu: '_MENU_',
                processing: '<span class="material-icons rotating" style="color:#1a1a1a; animation: spin 1s linear infinite;">sync</span> Loading...'
            }
        });
    });
</script>

<style>
    @keyframes spin {
        100% {
            transform: rotate(360deg);
        }
    }
</style>

{% endblock %}